# 주문 API TC-O1 시나리오 문서

## 목표
TEST_SUMMARY.md 94-101 라인의 **TC-O1.1**과 **TC-O1.2** 테스트를 최소 단위로 구현하여 더미 모드에서도 동작하도록 개선

---

## 현재 상황 분석

### 문제점
- **TC-O1.1**: HTTP 상태 코드 검증 - 더미 모드에서 스킵됨
- **TC-O1.2**: 응답 본문 구조 검증 - 더미 모드에서 스킵됨
- 더미 모드에서는 `Order.create()`가 에러를 던져 실제 주문 생성 불가

### 기존 테스트 구조
```javascript
// TC-O1.1과 TC-O1.2는 더미 모드 체크 후 스킵
if (USE_DUMMY_DATA) {
  console.log('Skipping order creation test in dummy data mode');
  return;
}
```

---

## 구현 시나리오

### 시나리오 1: 모킹을 활용한 최소 단위 테스트

#### TC-O1.1: HTTP 상태 코드 검증 (개선안)

**목표**: 더미 모드에서도 HTTP 상태 코드 검증 가능하도록 모킹 사용

**최소 단위 분해**:
1. **TC-O1.1.1**: 정상 요청 시 HTTP 201 상태 코드 반환 검증
   - `Order.create()` 모킹하여 성공 응답 시뮬레이션
   - `OrderItem.createMultiple()` 모킹
   - `Order.findById()` 모킹하여 주문 데이터 반환
   - 실제 HTTP 요청 없이 컨트롤러 로직만 테스트

2. **TC-O1.1.2**: 더미 모드에서도 동작 확인
   - 더미 모드 체크 제거
   - 모킹을 통해 데이터베이스 의존성 제거

**구현 방법**:
- `jest.mock()`을 사용하여 Order, OrderItem 모델 모킹
- 각 모델의 메서드를 모킹하여 예상되는 동작 시뮬레이션
- 실제 HTTP 요청은 유지하되, 내부 모델 호출은 모킹

---

#### TC-O1.2: 응답 본문 구조 검증 (개선안)

**목표**: 더미 모드에서도 응답 본문 구조 검증 가능하도록 모킹 사용

**최소 단위 분해**:
1. **TC-O1.2.1**: 응답 본문이 객체 타입인지 검증
   - Content-Type 헤더 검증 포함

2. **TC-O1.2.2**: 필수 필드 존재 확인
   - `order_id` 필드 존재 및 타입 검증
   - `status` 필드 존재 및 타입 검증
   - `created_at` 필드 존재 및 타입 검증

3. **TC-O1.2.3**: 필드 값 검증
   - `order_id`가 양수인지 검증
   - `status`가 '접수'인지 검증
   - `created_at`이 유효한 날짜 문자열인지 검증

**구현 방법**:
- TC-O1.1과 동일한 모킹 전략 사용
- 각 검증을 별도 테스트로 분리하여 최소 단위 보장

---

### 시나리오 2: 통합 테스트와 단위 테스트 분리

#### 접근 방식
- **통합 테스트**: 실제 데이터베이스 연결 시에만 실행 (기존 유지)
- **단위 테스트**: 모킹을 사용하여 더미 모드에서도 실행 가능

#### 테스트 구조
```
POST /api/orders
├── 통합 테스트 (실제 DB 필요)
│   ├── TC-O1.1: HTTP 상태 코드 검증
│   └── TC-O1.2: 응답 본문 구조 검증
└── 단위 테스트 (모킹 사용, 더미 모드 OK)
    ├── TC-O1.1.1: HTTP 상태 코드 검증 (모킹)
    ├── TC-O1.2.1: 응답 본문 타입 검증 (모킹)
    ├── TC-O1.2.2: 필수 필드 존재 확인 (모킹)
    └── TC-O1.2.3: 필드 값 검증 (모킹)
```

---

## 권장 구현 방안

### 방안 A: 모킹을 사용한 단위 테스트 추가 (추천)

**장점**:
- 더미 모드에서도 모든 테스트 실행 가능
- 빠른 실행 속도
- 데이터베이스 설정 불필요

**단점**:
- 모킹 설정 필요
- 실제 데이터베이스와의 차이 가능성

**구현 위치**:
- `tests/integration/api/orders.test.js`에 모킹 버전 테스트 추가
- 또는 `tests/unit/controllers/orderController.test.js`에 단위 테스트 추가

---

### 방안 B: 기존 테스트 개선 (대안)

**장점**:
- 기존 테스트 구조 유지
- 실제 통합 테스트 유지

**단점**:
- 더미 모드에서 여전히 스킵됨
- 데이터베이스 설정 필요

**구현 방법**:
- 기존 테스트에 모킹 옵션 추가
- 환경 변수로 모킹 모드 선택 가능하게 설정

---

## 최종 권장 시나리오

### 선택: 방안 A (모킹을 사용한 단위 테스트 추가)

#### 구현 단계

1. **단계 1**: 모킹 설정
   - `Order` 모델 모킹
   - `OrderItem` 모델 모킹
   - 각 메서드의 반환값 설정

2. **단계 2**: TC-O1.1 구현
   - 모킹된 Order.create()로 201 상태 코드 검증
   - 더미 모드 체크 제거

3. **단계 3**: TC-O1.2 세분화 구현
   - TC-O1.2.1: 응답 본문 타입 검증
   - TC-O1.2.2: 필수 필드 존재 확인
   - TC-O1.2.3: 필드 값 검증

4. **단계 4**: 테스트 실행 및 검증
   - 더미 모드에서도 통과 확인
   - 실제 DB 모드에서도 통과 확인

---

## 예상 결과

### 테스트 실행 전
```
POST /api/orders (14개 테스트)
  - ⏭️ TC-O1.1: HTTP 상태 코드 검증 (더미 모드 스킵)
  - ⏭️ TC-O1.2: 응답 본문 구조 검증 (더미 모드 스킵)
  - ✅ TC-O2.1 ~ TC-O2.4: 필수 필드 검증 (통과)
```

### 테스트 실행 후
```
POST /api/orders (16개 테스트) - 최소 단위로 세분화
  - ✅ TC-O1.1: HTTP 상태 코드 검증 (모킹 사용)
  - ✅ TC-O1.2.1: 응답 본문 타입 검증 (모킹 사용)
  - ✅ TC-O1.2.2: 필수 필드 존재 확인 (모킹 사용)
  - ✅ TC-O1.2.3: 필드 값 검증 (모킹 사용)
  - ✅ TC-O2.1 ~ TC-O2.4: 필수 필드 검증 (통과)
```

---

## 구현 시 주의사항

1. **모킹 범위**: Order와 OrderItem 모델만 모킹, 컨트롤러와 라우터는 실제 사용
2. **테스트 격리**: 각 테스트가 독립적으로 실행 가능해야 함
3. **기존 테스트 유지**: 기존 통합 테스트는 그대로 유지 (실제 DB 모드에서 실행)
4. **에러 케이스**: 모킹된 에러 상황도 테스트 가능하도록 설정

---

## 승인 요청

위 시나리오로 진행할까요? 승인해주시면 구현을 시작하겠습니다.

**구현 예상 시간**: 약 30분
**영향 범위**: `tests/integration/api/orders.test.js` 파일 수정

